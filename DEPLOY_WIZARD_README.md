# Deploy Script Improvements

## Changes Made (2026-01-25)

### 1. Relative Path Support ✅
- **Changed**: Removed static `/pwd` directory references
- **Before**: `BACKEND_DIR="${SCRIPT_DIR}/backend"`
- **After**: `BACKEND_DIR="${SCRIPT_DIR}"` (script runs from backend directory)
- **Benefit**: Script works from any location without hardcoded paths

### 2. Interactive .env Configuration Wizard ✅
A new interactive wizard to configure environment variables with:

#### Features:
- **Auto-detection**: Checks if `.env` exists and offers to reconfigure
- **Backup**: Automatically backs up existing `.env` before reconfiguration
- **Smart defaults**: Shows default values in brackets, press Enter to accept
- **Secure input**: Passwords are hidden during input (`read -sp`)
- **Auto-generation**: Generates secure random secrets for JWT and cursor tokens
- **Section-based**: Organized into logical sections for easier configuration

#### Sections:
1. **Application Settings**
   - Node environment (development/production)
   - Application port, name, company details

2. **Database Configuration**
   - PostgreSQL host, port, username, password, database name

3. **Security Configuration**
   - Auto-generates JWT_SECRET (256-bit)
   - Auto-generates CURSOR_SECRET
   - CORS origins configuration

4. **Redis Configuration**
   - Redis URL

5. **Object Storage (MinIO/S3)** (Optional)
   - MinIO endpoint, bucket, access keys

6. **Email Configuration (SMTP)** (Optional)
   - SMTP host, port, credentials, from address

7. **Monitoring & Telemetry** (Optional)
   - OpenTelemetry enablement
   - Zipkin endpoint

8. **Production Settings** (Auto-applied when NODE_ENV=production)
   - Sets DB_SYNCHRONIZE=false
   - Configures TRUST_PROXY
   - Generates METRICS_TOKEN

## Usage

### Run Configuration Wizard Only
```bash
cd backend
./deploy.sh --configure
```

### Run Full Deployment (wizard runs if .env is missing)
```bash
cd backend
./deploy.sh
```

### Reconfigure Environment
If `.env` already exists, the wizard will:
1. Detect the existing file
2. Ask if you want to reconfigure
3. Backup the old file with timestamp
4. Guide you through new configuration

### Example Workflow
```bash
# First time setup
cd /path/to/softy-erp/backend
./deploy.sh --configure          # Configure environment
./deploy.sh --infra              # Deploy infrastructure (DB, Redis, MinIO)
./deploy.sh --create-admin       # Deploy app and create admin

# Subsequent deployments
./deploy.sh --skip-deps --skip-migrations  # Quick redeploy
```

## Security Features

### Auto-Generated Secrets
The wizard automatically generates cryptographically secure secrets using:
- `openssl rand -base64 32` (preferred, 256-bit)
- Fallback to `/dev/urandom` if OpenSSL unavailable

### Secure Password Input
- All password prompts use `read -sp` to hide input
- No echoing to terminal
- Not logged to deployment log

### Production Hardening
When `NODE_ENV=production`, the wizard automatically:
- Disables database synchronization (`DB_SYNCHRONIZE=false`)
- Generates metrics token for secured endpoint access
- Prompts for proxy trust configuration

## File Structure

```
backend/
├── deploy.sh                    # Main deployment script (enhanced)
├── .env                         # Generated by wizard
├── .env.example                 # Template (required for wizard)
├── .env.backup.YYYYMMDD-HHMMSS # Auto-backup of previous config
└── deployment-YYYYMMDD-HHMMSS.log # Deployment log
```

## Benefits

1. **No Manual Editing**: Interactive prompts instead of manual .env editing
2. **Error Prevention**: Validates inputs and provides defaults
3. **Security**: Auto-generates strong secrets, hides sensitive inputs
4. **Portability**: Relative paths work from any directory
5. **Backup Safety**: Never lose your old configuration
6. **Flexible**: Can run wizard independently or as part of deployment
7. **Production-Ready**: Automatically applies production best practices

## Compatibility

- ✅ Linux (tested)
- ✅ macOS (tested)
- ✅ Bash 3.2+ (default on macOS)
- ✅ Bash 4+ (common on Linux)

## Environment Variables Reference

All variables from `.env.example` can be configured through the wizard:

**Required (always prompted):**
- Application settings
- Database credentials
- Security tokens (auto-generated)
- Redis URL

**Optional (prompted with y/N):**
- MinIO/S3 configuration
- Email/SMTP configuration
- Monitoring/telemetry

**Auto-configured for production:**
- DB_SYNCHRONIZE → false
- METRICS_TOKEN → auto-generated
- TRUST_PROXY → prompted

## Troubleshooting

### Wizard doesn't start
- Ensure `.env.example` exists in backend directory
- Check script has execute permissions: `chmod +x deploy.sh`

### Generated secrets look wrong
- Verify `openssl` is available: `which openssl`
- Fallback uses `/dev/urandom` if OpenSSL unavailable

### Can't overwrite .env
- Script will prompt before overwriting
- Old file backed up with timestamp
- Check file permissions

### Database connection fails
- Verify PostgreSQL is running
- Check host/port match your setup
- Verify credentials are correct

## Migration from Old deploy.sh

If you have an existing deployment:

1. **Backup your current .env**:
   ```bash
   cp backend/.env backend/.env.manual.backup
   ```

2. **Run the new script**:
   ```bash
   cd backend
   ./deploy.sh --configure
   ```

3. **Compare configurations**:
   ```bash
   diff backend/.env.manual.backup backend/.env
   ```

4. **Test deployment**:
   ```bash
   ./deploy.sh --no-start --skip-migrations
   ```
