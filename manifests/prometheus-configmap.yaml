apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: chapters-studio-erp
  labels:
    app: prometheus
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
      - job_name: 'chapters-studio-api'
        static_configs:
          - targets: ['chapters-studio-erp:3000']
        metrics_path: '/api/v1/metrics'
        scrape_interval: 10s
        bearer_token_file: '/etc/prometheus/secrets/metrics-token'

      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']

    alerting:
      alertmanagers:
        - static_configs:
            - targets: ['alertmanager:9093']

    rule_files:
      - '/etc/prometheus/rules/*.yaml'
---
apiVersion: v1
kind: Secret
metadata:
  name: prometheus-metrics-token
  namespace: chapters-studio-erp
  labels:
    app: prometheus
type: Opaque
stringData:
  metrics-token: "${METRICS_TOKEN}"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alert-rules
  namespace: chapters-studio-erp
  labels:
    app: prometheus
data:
  chapters-erp-alerts.yaml: |
    groups:
      - name: chapters-erp-alerts
        rules:
          - alert: HighErrorRate
            expr: rate(chapters_http_requests_total{status=~"5.."}[1m]) / rate(chapters_http_requests_total[1m]) > 0.05
            for: 2m
            labels:
              severity: critical
              owner: platform-team
            annotations:
              summary: "High HTTP 5xx error rate detected"
              description: "Error rate is above 5% for the last 2 minutes."
              acceptance_criteria: "Error rate must drop below 1% within 30 minutes"
              runbook_url: "https://docs.chapters-studio.com/runbooks/high-error-rate"

          - alert: HighLatency
            expr: histogram_quantile(0.95, rate(chapters_http_request_duration_seconds_bucket[5m])) > 2
            for: 5m
            labels:
              severity: warning
              owner: platform-team
            annotations:
              summary: "High API Latency"
              description: "P95 latency is above 2 seconds for the last 5 minutes."
              acceptance_criteria: "P95 latency must remain below 1 second"
              runbook_url: "https://docs.chapters-studio.com/runbooks/high-latency"

          - alert: PayrollProcessingStuck
            expr: chapters_erp_stuck_payouts > 0
            for: 1m
            labels:
              severity: critical
              owner: finance-team
            annotations:
              summary: "Payroll Processing Stuck"
              description: "There are {{ $value }} payouts stuck in PENDING state for > 10 minutes."
              acceptance_criteria: "All stuck payouts must be resolved within 2 hours"
              runbook_url: "https://docs.chapters-studio.com/runbooks/payroll-reconciliation"

          - alert: PayrollReconciliationMismatch
            expr: chapters_payroll_reconciliation_mismatches_total > 0
            for: 1m
            labels:
              severity: critical
              owner: finance-team
            annotations:
              summary: "Payroll Reconciliation Mismatch Detected"
              description: "{{ $value }} payroll mismatches detected between gateway and database."
              acceptance_criteria: "All mismatches must be investigated and tickets resolved within 24 hours"
              runbook_url: "https://docs.chapters-studio.com/runbooks/payroll-reconciliation"

          - alert: ReconciliationJobFailed
            expr: chapters_payroll_reconciliation_failures_total > 0
            for: 5m
            labels:
              severity: warning
              owner: platform-team
            annotations:
              summary: "Payroll Reconciliation Job Failed"
              description: "The nightly reconciliation job has failed."
              acceptance_criteria: "Job must be manually re-run and root cause investigated"
              runbook_url: "https://docs.chapters-studio.com/runbooks/reconciliation-job"

          - alert: WebhookDeliveryFailure
            expr: rate(chapters_webhook_delivery_failures_total[5m]) > 0.1
            for: 5m
            labels:
              severity: warning
              owner: integrations-team
            annotations:
              summary: "Webhook Delivery Failures"
              description: "Webhook delivery failure rate is increasing."
              acceptance_criteria: "Webhook success rate must be above 99%"
              runbook_url: "https://docs.chapters-studio.com/runbooks/webhook-failures"
