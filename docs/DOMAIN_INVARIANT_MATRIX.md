# Domain Invariant Matrix

| Flow                                                              | Invariant(s)                                                                                                                                                            | Covered-by test(s)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Failure-path expectation                                                                                                                                                                                                                                                                                                               |
| ----------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Booking confirmation -> task generation -> finance income posting | Confirming a draft booking must atomically set booking status to `CONFIRMED`, create booking tasks in `PENDING`, and create one `INCOME` transaction for booking value. | `test/workflows.e2e-spec.ts` :: `Booking Confirmation Workflow > should confirm booking and create tasks`; `test/workflows.e2e-spec.ts` :: `Booking Confirmation Workflow > should have created tasks for the booking`; `test/workflows.e2e-spec.ts` :: `Booking Confirmation Workflow > should have created income transaction for the booking`; `test/integration/workflows/booking-finance-integrity.integration.spec.ts` :: `creates booking tasks and finance transaction on successful confirmation` | `test/integration/workflows/booking-finance-integrity.integration.spec.ts` :: `rolls back confirmation when finance transaction step fails` asserts booking remains `DRAFT`, tasks count remains `0`, and transactions count remains `0` (rollback/no partial writes).                                                                 |
| Task completion -> wallet payable movement -> dashboard broadcast | Completing an in-progress task with positive commission must move commission to payable wallet inside transaction and emit tenant-scoped dashboard revenue broadcast.   | `test/workflows.e2e-spec.ts` :: `Task Completion with Commission Flow > should complete task and add to payable wallet`; `test/workflows.e2e-spec.ts` :: `Task Completion with Commission Flow > should have updated wallet payable balance`                                                                                                                                                                                                                                                               | `test/workflows.e2e-spec.ts` :: `Task Completion with Commission Flow > should rollback task completion when wallet payable movement fails` expects non-2xx, task status remains `IN_PROGRESS`, and wallet balances are unchanged (rollback/no partial writes).                                                                        |
| Booking cancellation lifecycle                                    | Cancellation must publish one `BookingCancelledEvent` only after durable cancellation write; cancellation metadata must include tenant + reason.                        | `src/modules/bookings/services/booking-workflow.service.spec.ts` :: `cancelBooking > publishes BookingCancelledEvent once after cancellation commit`                                                                                                                                                                                                                                                                                                                                                       | Invalid transitions must fail before persistence side effects; `src/modules/bookings/services/booking-state-machine.service.spec.ts` :: `executeTransition > should fail if transition is invalid` verifies save callback is not called (no partial writes).                                                                           |
| Booking completion lifecycle                                      | Completion must publish one `BookingCompletedEvent` only after durable completion write for a confirmed booking.                                                        | `src/modules/bookings/services/booking-workflow.service.spec.ts` :: `completeBooking > publishes BookingCompletedEvent once after completion commit`                                                                                                                                                                                                                                                                                                                                                       | Invalid completion transitions must be rejected pre-write by state machine guard; `src/modules/bookings/services/booking-state-machine.service.spec.ts` :: `validateTransition > should throw BadRequestException for invalid transitions` and `executeTransition > should fail if transition is invalid` preserve no-write guarantee. |
